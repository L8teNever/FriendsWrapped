<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Friends Wrapped</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');

        :root {
            --primary: #8b5cf6;
            --primary-hover: #7c3aed;
            --bg-main: #f8fafc;
            --bg-card: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-main);
        }

        .sidebar {
            background-color: #ffffff;
            border-right: 1px solid var(--border);
        }

        .nav-link {
            color: var(--text-muted);
            transition: all 0.2s;
        }

        .nav-link:hover {
            color: var(--primary);
            background-color: #f5f3ff;
        }

        .nav-link.active {
            color: var(--primary);
            background-color: #f5f3ff;
            border-right: 3px solid var(--primary);
        }

        .glass-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
        }

        .category-header {
            background-color: #f1f5f9;
            transition: all 0.2s;
        }

        .category-header:hover {
            background-color: #e2e8f0;
        }

        .input-field {
            background-color: #ffffff;
            border: 1px solid var(--border);
            transition: all 0.2s;
        }

        .input-field:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
            outline: none;
        }

        details summary::-webkit-details-marker {
            display: none;
        }

        .stat-row {
            background-color: #f8fafc;
            border: 1px solid var(--border);
        }
    </style>
</head>

<body class="min-h-screen flex">

    <!-- Sidebar -->
    <aside class="w-64 sidebar fixed h-full flex flex-col z-50">
        <div class="p-8 mb-4">
            <div class="flex items-center gap-3">
                <div
                    class="w-10 h-10 bg-gradient-to-tr from-violet-600 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg shadow-violet-200">
                    <i data-lucide="heart" class="w-6 h-6 text-white"></i>
                </div>
                <span class="font-bold text-xl tracking-tight text-slate-800">Wrapped Admin</span>
            </div>
        </div>

        <nav class="flex-1 px-4 space-y-1">
            <a href="#content"
                class="nav-link active flex items-center gap-3 px-4 py-3 rounded-xl font-semibold text-sm">
                <i data-lucide="settings" class="w-5 h-5"></i> Content Editor
            </a>
            <a href="#media" class="nav-link flex items-center gap-3 px-4 py-3 rounded-xl font-semibold text-sm">
                <i data-lucide="image" class="w-5 h-5"></i> Media Library
            </a>
            <a href="#users" class="nav-link flex items-center gap-3 px-4 py-3 rounded-xl font-semibold text-sm">
                <i data-lucide="users" class="w-5 h-5"></i> Benutzer-Manager
            </a>
        </nav>

        <div class="p-6 mt-auto border-t border-slate-100 space-y-3">
            <a href="{{ url_for('index') }}" target="_blank"
                class="w-full py-2.5 px-4 bg-slate-50 text-slate-600 rounded-xl text-xs font-bold uppercase tracking-wider flex items-center justify-center gap-2 hover:bg-slate-100 transition">
                <i data-lucide="eye" class="w-4 h-4"></i> Website Vorschau
            </a>
            <a href="{{ url_for('logout') }}"
                class="w-full py-2.5 px-4 bg-red-50 text-red-600 rounded-xl text-xs font-bold uppercase tracking-wider flex items-center justify-center gap-2 hover:bg-red-100 transition">
                <i data-lucide="log-out" class="w-4 h-4"></i> Logout
            </a>
        </div>
    </aside>

    <!-- Content -->
    <main class="flex-1 ml-64 p-12">
        <header class="mb-12 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-extrabold text-slate-900 tracking-tight">Admin Dashboard</h1>
                <p class="text-slate-500 mt-1">Passe deine Friendship-Story in Echtzeit an.</p>
            </div>

            {% with messages = get_flashed_messages() %}
            {% if messages %}
            <div
                class="flex items-center gap-3 bg-emerald-50 text-emerald-700 px-6 py-3 rounded-2xl border border-emerald-100 font-bold text-sm shadow-sm animate-bounce">
                <i data-lucide="sparkles" class="w-5 h-5"></i> {{ messages[0] }}
            </div>
            {% endif %}
            {% endwith %}
        </header>

        <form method="POST" enctype="multipart/form-data" class="space-y-8">
            {% set categories = [
            ('üöÄ Basis-Einstellungen', 'zap', 'none', ['page_title', 'character_name', 'title_main', 'intro_text']),
            ('üéÇ Geburtstag', 'gift', 'show_birthday', ['birthday_title', 'birthday_age', 'birthday_text']),
            ('üìä Highlights & Zahlen', 'bar-chart-2', 'show_stats', ['stats_title', 'years_count', 'days_count',
            'stats_subtitle', 'chat_stats_title', 'chat_stats_config']),
            ('üìà WhatsApp Vibes', 'message-circle', 'show_whatsapp', ['wa_title', 'wa_messages']),
            ('üì∏ Damals & Heute', 'camera', 'show_development', ['img_then', 'img_now']),
            ('üéµ Musik & Highlights', 'music', 'show_music', ['song_title', 'song_artist', 'song_cover',
            'highlight_label']),
            ('üåç Trips & Abenteuer', 'map-pin', 'show_highlights', ['trip_city', 'trip_bg', 'gallery_paris',
            'gallery_memes']),
            ('üìå Post-it Wand', 'sticky-note', 'show_postits', ['postits_title', 'postits_content']),
            ('‚ú® Das Finale', 'star', 'show_character', ['chaos_title', 'bucket_title', 'analyzing_text',
            'character_type_label', 'character_type', 'final_msg_title', 'final_msg_text', 'final_sender_name'])
            ] %}

            <div class="grid grid-cols-1 gap-6">
                {% for cat_name, cat_icon, show_key, cat_keys in categories %}
                <details class="glass-card rounded-3xl overflow-hidden group" data-category="{{ cat_name }}" {% if
                    loop.first %}open{% endif %}>
                    <summary class="category-header flex items-center justify-between p-7 cursor-pointer">
                        <div class="flex items-center gap-5">
                            <div
                                class="w-12 h-12 bg-white rounded-2xl flex items-center justify-center border border-slate-200 shadow-sm transition group-hover:scale-110">
                                <i data-lucide="{{ cat_icon }}" class="w-6 h-6 text-violet-600"></i>
                            </div>
                            <h2 class="text-xl font-bold text-slate-800">{{ cat_name }}</h2>
                        </div>
                        <div class="flex items-center gap-4">
                            {% if show_key != 'none' %}
                            {% set show_config = configs | selectattr('key', 'equalto', show_key) | first %}
                            <div class="flex items-center gap-2 px-3 py-1.5 bg-white border border-slate-200 rounded-full shadow-sm"
                                onclick="event.stopPropagation()">
                                <span
                                    class="text-[10px] font-black uppercase tracking-widest text-slate-400">Sichtbar</span>
                                <input type="hidden" name="config_{{ show_key }}"
                                    value="{{ 'true' if show_config and show_config.value == 'true' else 'false' }}"
                                    id="hidden_{{ show_key }}">
                                <button type="button" onclick="
                                        const h = document.getElementById('hidden_{{ show_key }}');
                                        const b = this;
                                        const isTrue = h.value === 'true';
                                        h.value = isTrue ? 'false' : 'true';
                                        b.classList.toggle('bg-emerald-500', !isTrue);
                                        b.classList.toggle('bg-slate-200', isTrue);
                                        b.querySelector('div').classList.toggle('translate-x-4', !isTrue);
                                    "
                                    class="w-10 h-6 {{ 'bg-emerald-500' if show_config and show_config.value == 'true' else 'bg-slate-200' }} rounded-full p-1 transition-colors relative">
                                    <div
                                        class="w-4 h-4 bg-white rounded-full shadow-sm transform transition-transform {{ 'translate-x-4' if show_config and show_config.value == 'true' else '' }}">
                                    </div>
                                </button>
                            </div>
                            {% endif %}
                            <i data-lucide="chevron-down"
                                class="w-6 h-6 text-slate-400 transition-transform group-open:rotate-180"></i>
                        </div>
                    </summary>

                    <div class="p-10 grid grid-cols-1 lg:grid-cols-2 gap-10 border-t border-slate-100">
                        {% for key in cat_keys %}
                        {% set config = configs | selectattr('key', 'equalto', key) | first %}
                        {% if config %}
                        <div class="flex flex-col gap-3">
                            <label class="text-xs font-extrabold text-slate-400 uppercase tracking-widest">{{ config.key
                                }}</label>

                            {% if config.key.startswith('img_') or config.key.endswith('_cover') or
                            config.key.endswith('_bg') or config.key.startswith('gallery_') %}
                            <div
                                class="flex items-center gap-5 p-5 bg-slate-50 rounded-2xl border border-slate-200 shadow-inner">
                                <div class="flex-1 space-y-3">
                                    <div class="flex gap-2">
                                        <input type="text" name="config_{{ config.key }}" value="{{ config.value }}"
                                            id="input_{{ config.key }}"
                                            class="flex-1 bg-white px-4 py-2 rounded-xl text-sm border border-slate-200 outline-none focus:border-violet-400 focus:ring-2 focus:ring-violet-50 transition"
                                            placeholder="URL...">
                                        <button type="button"
                                            onclick="openMediaPicker('input_{{ config.key }}', {{ 'true' if config.key.startswith('gallery_') else 'false' }})"
                                            class="px-4 py-2 bg-violet-600 text-white rounded-xl text-xs font-bold hover:bg-violet-700 transition flex items-center gap-2">
                                            <i data-lucide="search" class="w-4 h-4"></i> Ausw√§hlen
                                        </button>
                                    </div>
                                    {% if config.key.startswith('gallery_') %}
                                    <div id="preview_list_{{ config.key }}" class="flex flex-wrap gap-2 mt-2"></div>
                                    <script>
                                        document.addEventListener('DOMContentLoaded', () => {
                                            updateGalleryPreview('input_{{ config.key }}', 'preview_list_{{ config.key }}');
                                            document.getElementById('input_{{ config.key }}').addEventListener('change', () => {
                                                updateGalleryPreview('input_{{ config.key }}', 'preview_list_{{ config.key }}');
                                            });
                                        });
                                    </script>
                                    {% else %}
                                    <div
                                        class="w-20 h-20 rounded-xl overflow-hidden border border-slate-200 shadow-sm bg-white">
                                        <img src="{{ config.value }}" id="preview_{{ config.key }}"
                                            class="w-full h-full object-cover">
                                    </div>
                                    <script>
                                        document.getElementById('input_{{ config.key }}').addEventListener('input', (e) => {
                                            document.getElementById('preview_{{ config.key }}').src = e.target.value;
                                        });
                                    </script>
                                    {% endif %}
                                </div>
                            </div>
                            {% else %}
                            {% if config.key == 'chat_stats_config' %}
                            <div id="stats-builder-container" class="space-y-4">
                                <div id="stats-list" class="space-y-3"></div>
                                <button type="button" onclick="addStatRow()"
                                    class="w-full py-3 bg-white border-2 border-dashed border-slate-200 rounded-2xl text-slate-400 font-bold text-sm hover:border-violet-300 hover:text-violet-500 transition flex items-center justify-center gap-2">
                                    <i data-lucide="plus-circle" class="w-5 h-5"></i> Element hinzuf√ºgen
                                </button>
                                <textarea name="config_{{ config.key }}" id="stats-hidden-input"
                                    class="hidden">{{ config.value }}</textarea>
                            </div>
                            {% elif config.key == 'wa_messages' %}
                            <div id="wa-builder-container" class="space-y-4">
                                <div id="wa-list" class="space-y-3"></div>
                                <button type="button" onclick="addWaRow()"
                                    class="w-full py-3 bg-white border-2 border-dashed border-slate-200 rounded-2xl text-slate-400 font-bold text-sm hover:border-violet-300 hover:text-violet-500 transition flex items-center justify-center gap-2">
                                    <i data-lucide="plus-circle" class="w-5 h-5"></i> Nachricht hinzuf√ºgen
                                </button>
                                <textarea name="config_{{ config.key }}" id="wa-hidden-input"
                                    class="hidden">{{ config.value }}</textarea>
                            </div>
                            {% else %}
                            <div class="relative">
                                {% if config.key == 'postits_content' %}
                                <div id="postits-builder-container" class="space-y-4">
                                    <div id="postits-list" class="flex flex-wrap gap-3"></div>
                                    <button type="button" onclick="addPostitRow()"
                                        class="w-full py-3 bg-white border-2 border-dashed border-slate-200 rounded-2xl text-slate-400 font-bold text-sm hover:border-violet-300 hover:text-violet-500 transition flex items-center justify-center gap-2">
                                        <i data-lucide="plus-circle" class="w-5 h-5"></i> Post-it hinzuf√ºgen
                                    </button>
                                    <textarea name="config_{{ config.key }}" id="postits-hidden-input"
                                        class="hidden">{{ config.value }}</textarea>
                                </div>
                                <script>
                                    function updatePostitsInput() {
                                        const values = [];
                                        document.querySelectorAll('.postit-input').forEach(input => {
                                            if (input.value.trim()) values.push(input.value.trim());
                                        });
                                        document.getElementById('postits-hidden-input').value = values.join(',');
                                    }

                                    function addPostitRow(val = '') {
                                        const container = document.getElementById('postits-list');
                                        const wrapper = document.createElement('div');
                                        wrapper.className = 'flex items-center gap-2 bg-yellow-50 p-3 rounded-xl border border-yellow-200 shadow-sm';
                                        wrapper.innerHTML = `
                                            <input type="text" value="${val}" class="postit-input bg-transparent text-sm font-bold text-yellow-800 outline-none w-40" placeholder="Text..." oninput="updatePostitsInput()">
                                            <button type="button" onclick="this.parentElement.remove(); updatePostitsInput();" class="text-yellow-400 hover:text-red-500 transition">
                                                <i data-lucide="x-circle" class="w-4 h-4"></i>
                                            </button>
                                        `;
                                        container.appendChild(wrapper);
                                        lucide.createIcons();
                                    }

                                    document.addEventListener('DOMContentLoaded', () => {
                                        const val = document.getElementById('postits-hidden-input').value;
                                        const items = val.split(',').filter(x => x.trim());
                                        if (items.length === 0) addPostitRow();
                                        else items.forEach(i => addPostitRow(i));
                                    });
                                </script>
                                {% elif config.value and (config.value|length > 50 or '\n' in config.value) %}
                                <textarea name="config_{{ config.key }}" rows="3"
                                    class="w-full input-field p-5 rounded-2xl text-slate-700 text-sm shadow-sm resize-none"
                                    placeholder="...">{{ config.value }}</textarea>
                                {% else %}
                                <input type="text" name="config_{{ config.key }}" value="{{ config.value }}"
                                    class="w-full input-field px-6 py-4 rounded-2xl text-slate-700 text-sm shadow-sm"
                                    placeholder="...">
                                {% endif %}
                            </div>
                            {% endif %}
                            {% endif %}
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </details>
                {% endfor %}
            </div>

            <div class="sticky bottom-10 z-50 flex justify-center">
                <button type="submit" id="save-btn"
                    class="px-12 py-5 bg-gradient-to-r from-violet-600 to-indigo-600 text-white font-black text-lg rounded-full shadow-2xl shadow-violet-200 hover:scale-105 active:scale-95 transition-all flex items-center gap-4">
                    <i data-lucide="save" id="save-icon" class="w-6 h-6"></i>
                    <span id="save-text">√Ñnderungen speichern</span>
                </button>
            </div>
        </form>

        <!-- Media Library Section -->
        <section id="media" class="hidden mt-32 pt-20 border-t border-slate-200">
            <div class="mb-12 flex justify-between items-end">
                <div>
                    <h2 class="text-3xl font-extrabold text-slate-900 tracking-tight">Media Library</h2>
                    <p class="text-slate-500 mt-2">Verwalte deine Bilder und Videos an einem zentralen Ort.</p>
                </div>
                <div>
                    <input type="file" id="media-upload-input" class="hidden" multiple accept="image/*">
                    <button onclick="document.getElementById('media-upload-input').click()"
                        class="px-6 py-3 bg-violet-600 text-white font-bold rounded-2xl hover:bg-violet-700 transition flex items-center gap-3">
                        <i data-lucide="upload-cloud" class="w-5 h-5"></i> Bilder hochladen
                    </button>
                </div>
            </div>

            <div id="media-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-6">
                <!-- Media files will be loaded here -->
            </div>
        </section>

        <!-- User Management -->
        <section id="users" class="mt-32 pt-20 border-t border-slate-200">
            <div class="mb-12">
                <h2 class="text-3xl font-extrabold text-slate-900 tracking-tight">Benutzer & Links</h2>
                <p class="text-slate-500 mt-2">Verwalte hier, wer deine Story ansehen darf.</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
                <div class="lg:col-span-1">
                    <div class="glass-card p-10 rounded-3xl sticky top-12">
                        <h3 class="text-xl font-bold mb-6 text-slate-800">Neuen Zugang erstellen</h3>
                        <form action="{{ url_for('create_user') }}" method="POST" class="space-y-5">
                            <input type="text" name="username" placeholder="Name des Empf√§ngers"
                                class="w-full input-field px-6 py-4 rounded-2xl text-sm" required>
                            <button type="submit"
                                class="w-full py-4 bg-slate-900 text-white font-bold rounded-2xl hover:bg-slate-800 transition flex items-center justify-center gap-3">
                                <i data-lucide="user-plus" class="w-5 h-5"></i> Erstellen
                            </button>
                        </form>
                    </div>
                </div>

                <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                    {% for user in users %}
                    <div
                        class="glass-card p-8 rounded-3xl flex flex-col gap-6 group hover:border-violet-200 transition">
                        <div class="flex items-center gap-5">
                            <div
                                class="w-14 h-14 bg-violet-100 text-violet-600 rounded-2xl flex items-center justify-center font-black text-xl">
                                {{ user.username[0] | upper }}
                            </div>
                            <div>
                                <h4 class="text-lg font-bold text-slate-800">{{ user.username }}</h4>
                                <span
                                    class="bg-slate-100 text-slate-500 px-3 py-1 rounded-full font-bold text-[10px] uppercase tracking-widest">{{
                                    user.role }}</span>
                            </div>
                        </div>

                        {% if user.magic_token %}
                        <div class="space-y-3">
                            <label class="text-[11px] font-black text-slate-400 uppercase tracking-widest">Dein Magic
                                Link</label>
                            <div class="bg-indigo-50 border border-indigo-100/50 p-4 rounded-2xl text-xs font-semibold text-indigo-600 break-all cursor-pointer hover:bg-indigo-100 transition relative overflow-hidden group/link"
                                onclick="navigator.clipboard.writeText(this.innerText.trim()); alert('Link kopiert!')">
                                {{ host_url }}/magic/{{ user.magic_token }}
                                <div
                                    class="absolute inset-0 bg-indigo-600 opacity-0 group-hover/link:opacity-95 flex items-center justify-center transition rounded-2xl text-white font-bold text-sm">
                                    <i data-lucide="copy" class="w-4 h-4 mr-2"></i> Kopieren
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <a href="{{ url_for('generate_link', user_id=user.id) }}"
                            class="py-3 bg-violet-50 text-violet-600 text-center rounded-xl font-bold text-sm hover:bg-violet-100 transition">
                            Link jetzt generieren
                        </a>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </section>
    </main>

    <!-- Full Image Preview Modal -->
    <div id="full-image-modal"
        class="fixed inset-0 z-[200] bg-slate-900/95 backdrop-blur-xl hidden items-center justify-center p-4 md:p-12"
        onclick="closeFullImage()">
        <button class="absolute top-8 right-8 p-3 bg-white/10 hover:bg-white/20 rounded-full text-white transition">
            <i data-lucide="x" class="w-8 h-8"></i>
        </button>
        <img id="full-preview-img" src=""
            class="max-w-full max-h-full object-contain rounded-2xl shadow-2xl border border-white/10"
            onclick="event.stopPropagation()">
    </div>

    <!-- Media Picker Modal -->
    <div id="media-picker-modal"
        class="fixed inset-0 z-[100] bg-slate-900/50 backdrop-blur-sm hidden items-center justify-center p-6">
        <div class="bg-white w-full max-w-4xl max-h-[80vh] rounded-[2.5rem] shadow-2xl flex flex-col overflow-hidden">
            <div class="p-8 border-b border-slate-100 flex justify-between items-center">
                <div>
                    <h3 class="text-2xl font-black text-slate-900">Bilder ausw√§hlen</h3>
                    <p id="picker-mode-text" class="text-slate-400 text-sm font-bold uppercase tracking-widest mt-1">
                        Single Select</p>
                </div>
                <button onclick="closeMediaPicker()" class="p-2 hover:bg-slate-100 rounded-xl transition">
                    <i data-lucide="x" class="w-6 h-6 text-slate-400"></i>
                </button>
            </div>
            <div id="picker-grid"
                class="flex-1 overflow-y-auto p-8 grid grid-cols-2 lg:grid-cols-4 gap-6 bg-slate-50 content-start">
                <!-- Images loaded here -->
            </div>
            <div class="p-8 border-t border-slate-100 flex justify-end gap-4 bg-white">
                <button onclick="closeMediaPicker()"
                    class="px-8 py-3 bg-slate-100 text-slate-600 font-bold rounded-2xl hover:bg-slate-200 transition">Abbrechen</button>
                <button id="confirm-selection"
                    class="px-8 py-3 bg-violet-600 text-white font-bold rounded-2xl hover:bg-violet-700 transition shadow-lg shadow-violet-200">√úbernehmen</button>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // Navigation logic
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                const href = link.getAttribute('href');
                if (!href.startsWith('#')) return;
                const targetId = href.substring(1);

                // Set active link
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                link.classList.add('active');

                // Toggle visibility
                document.querySelectorAll('main > form, main > section').forEach(el => el.classList.add('hidden'));

                if (targetId === 'content') {
                    document.querySelector('main > form').classList.remove('hidden');
                } else {
                    const section = document.getElementById(targetId);
                    if (section) section.classList.remove('hidden');
                }

                if (targetId === 'media') loadMediaLibrary();
            });
        });

        // Media Library Logic
        async function loadMediaLibrary() {
            const res = await fetch('/admin/media');
            const data = await res.json();
            const grid = document.getElementById('media-grid');
            if (!grid) return;
            grid.innerHTML = data.files.map(file => `
                <div class="group relative aspect-square bg-white rounded-2xl border border-slate-200 overflow-hidden hover:border-violet-400 transition shadow-sm">
                    <img src="${file.url}" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-slate-900/60 opacity-0 group-hover:opacity-100 transition flex items-center justify-center gap-2">
                        <button onclick="showFullImage('${file.url}')" class="p-3 bg-white/20 text-white rounded-xl hover:bg-white/30 backdrop-blur-sm transition">
                            <i data-lucide="eye" class="w-5 h-5"></i>
                        </button>
                        <button onclick="deleteMedia('${file.name}')" class="p-3 bg-red-500/80 text-white rounded-xl hover:bg-red-500 backdrop-blur-sm transition">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        async function deleteMedia(filename) {
            if (!confirm('Bild wirklich l√∂schen?')) return;
            await fetch('/admin/media/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename })
            });
            loadMediaLibrary();
        }

        const mUploadInput = document.getElementById('media-upload-input');
        if (mUploadInput) {
            mUploadInput.addEventListener('change', async (e) => {
                for (const file of e.target.files) {
                    const formData = new FormData();
                    formData.append('file', file);
                    await fetch('/admin/media/upload', {
                        method: 'POST',
                        body: formData
                    });
                }
                loadMediaLibrary();
            });
        }

        // Media Picker Logic
        let currentTargetInputId = null;
        let multiSelect = false;
        let selectedUrls = [];

        async function openMediaPicker(inputId, isMulti = false) {
            currentTargetInputId = inputId;
            multiSelect = isMulti;
            const inputVal = document.getElementById(inputId).value;
            selectedUrls = multiSelect ? inputVal.split(',').filter(x => x) : [inputVal];

            document.getElementById('picker-mode-text').innerText = multiSelect ? 'Multi Select (Mehrere)' : 'Single Select (Eins)';
            const modal = document.getElementById('media-picker-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            const res = await fetch('/admin/media');
            const data = await res.json();
            const grid = document.getElementById('picker-grid');
            grid.innerHTML = data.files.map(file => {
                const isSelected = selectedUrls.includes(file.url);
                return `
                    <div onclick="togglePickerSelection('${file.url}', this)" 
                         class="media-item group relative aspect-square bg-white rounded-2xl border-4 ${isSelected ? 'border-violet-500' : 'border-slate-100'} overflow-hidden cursor-pointer hover:border-violet-300 transition">
                        <img src="${file.url}" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-slate-900/40 opacity-0 group-hover:opacity-100 transition flex items-center justify-center">
                             <button onclick="event.stopPropagation(); showFullImage('${file.url}')" class="p-2 bg-white/20 text-white rounded-lg hover:bg-white/40 backdrop-blur-md transition">
                                <i data-lucide="maximize-2" class="w-4 h-4"></i>
                             </button>
                        </div>
                        ${isSelected ? '<div class="check-badge absolute top-2 right-2 bg-violet-500 text-white p-1 rounded-full"><i data-lucide="check" class="w-4 h-4"></i></div>' : ''}
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        function togglePickerSelection(url, el) {
            if (multiSelect) {
                if (selectedUrls.includes(url)) {
                    selectedUrls = selectedUrls.filter(u => u !== url);
                    el.classList.replace('border-violet-500', 'border-slate-100');
                    const badge = el.querySelector('.check-badge');
                    if (badge) badge.remove();
                } else {
                    selectedUrls.push(url);
                    el.classList.replace('border-slate-100', 'border-violet-500');
                    const badge = document.createElement('div');
                    badge.className = 'check-badge absolute top-2 right-2 bg-violet-500 text-white p-1 rounded-full';
                    badge.innerHTML = '<i data-lucide="check" class="w-4 h-4"></i>';
                    el.appendChild(badge);
                    lucide.createIcons();
                }
            } else {
                selectedUrls = [url];
                document.querySelectorAll('.media-item').forEach(d => {
                    d.classList.replace('border-violet-500', 'border-slate-100');
                    const b = d.querySelector('.check-badge');
                    if (b) b.remove();
                });
                el.classList.replace('border-slate-100', 'border-violet-500');
                const badge = document.createElement('div');
                badge.className = 'check-badge absolute top-2 right-2 bg-violet-500 text-white p-1 rounded-full';
                badge.innerHTML = '<i data-lucide="check" class="w-4 h-4"></i>';
                el.appendChild(badge);
                lucide.createIcons();
            }
        }

        function closeMediaPicker() {
            const modal = document.getElementById('media-picker-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        document.getElementById('confirm-selection').addEventListener('click', () => {
            const input = document.getElementById(currentTargetInputId);
            input.value = selectedUrls.join(',');
            input.dispatchEvent(new Event('input', { bubbles: true }));
            input.dispatchEvent(new Event('change', { bubbles: true }));
            closeMediaPicker();
        });

        function updateGalleryPreview(inputId, listId) {
            const input = document.getElementById(inputId);
            if (!input) return;
            const urls = input.value.split(',').filter(x => x);
            const list = document.getElementById(listId);
            if (!list) return;
            list.innerHTML = urls.map(url => `
                <div class="w-16 h-16 rounded-lg overflow-hidden border border-slate-200 shadow-sm relative group">
                    <img src="${url}" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-slate-900/60 opacity-0 group-hover:opacity-100 transition flex items-center justify-center gap-1">
                        <button onclick="showFullImage('${url}')" class="p-1 text-white hover:text-violet-300 transition">
                            <i data-lucide="eye" class="w-3.5 h-3.5"></i>
                        </button>
                        <button onclick="removeFromGallery('${inputId}', '${url}')" class="p-1 text-white hover:text-red-400 transition">
                            <i data-lucide="x" class="w-3.5 h-3.5"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        window.removeFromGallery = function (inputId, url) {
            const input = document.getElementById(inputId);
            const urls = input.value.split(',').filter(u => u !== url);
            input.value = urls.join(',');
            input.dispatchEvent(new Event('change', { bubbles: true }));
        };

        // Full Image Preview Logic
        window.showFullImage = function (url) {
            const modal = document.getElementById('full-image-modal');
            const img = document.getElementById('full-preview-img');
            img.src = url;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.style.overflow = 'hidden'; // Prevent scroll
        }

        window.closeFullImage = function () {
            const modal = document.getElementById('full-image-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.style.overflow = ''; // Restore scroll
        }

        // Stats Builder JS
        function parseStats() {
            const input = document.getElementById('stats-hidden-input');
            if (!input) return [];
            return input.value.split('\n').filter(l => l.trim()).map(l => {
                const p = l.split('|');
                return { icon: p[0] || 'heart', val: p[1] || '0', label: p[2] || '' };
            });
        }

        function updateStatsInput() {
            const lines = [];
            document.querySelectorAll('.stat-builder-row').forEach(row => {
                const i = row.querySelector('.s-icon').value;
                const v = row.querySelector('.s-val').value;
                const l = row.querySelector('.s-label').value;
                if (i || v || l) lines.push(`${i}|${v}|${l}`);
            });
            document.getElementById('stats-hidden-input').value = lines.join('\n');
        }

        function addStatRow(data = { icon: 'heart', val: '10', label: 'Neuer Grund' }) {
            const container = document.getElementById('stats-list');
            if (!container) return;
            const row = document.createElement('div');
            row.className = 'stat-builder-row flex items-center gap-3 p-4 bg-white border border-slate-100 rounded-2xl shadow-sm';
            row.innerHTML = `
                <input type="text" value="${data.icon}" class="s-icon w-24 bg-slate-50 px-3 py-2 rounded-xl text-xs font-bold text-violet-600 border border-transparent focus:border-violet-200 outline-none" placeholder="Icon" oninput="updateStatsInput()">
                <input type="text" value="${data.val}" class="s-val w-20 bg-slate-50 px-3 py-2 rounded-xl text-xs font-black text-slate-800 border border-transparent focus:border-violet-200 outline-none" placeholder="Wert" oninput="updateStatsInput()">
                <input type="text" value="${data.label}" class="s-label flex-1 bg-slate-50 px-3 py-2 rounded-xl text-xs font-semibold text-slate-500 border border-transparent focus:border-violet-200 outline-none" placeholder="Label" oninput="updateStatsInput()">
                <button type="button" onclick="this.parentElement.remove(); updateStatsInput();" class="text-slate-300 hover:text-red-500 transition">
                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                </button>
            `;
            container.appendChild(row);
            lucide.createIcons();
        }

        // WhatsApp Builder JS
        function updateWaInput() {
            const lines = [];
            document.querySelectorAll('.wa-builder-input').forEach(input => {
                if (input.value.trim()) lines.push(input.value.trim());
            });
            const hidden = document.getElementById('wa-hidden-input');
            if (hidden) hidden.value = lines.join('\n');
        }

        function addWaRow(val = '') {
            const container = document.getElementById('wa-list');
            if (!container) return;
            const wrapper = document.createElement('div');
            wrapper.className = 'flex items-center gap-3 p-4 bg-[#f1f9f6] border border-emerald-100 rounded-2xl shadow-sm';
            wrapper.innerHTML = `
                <div class="w-2 h-2 bg-emerald-400 rounded-full"></div>
                <input type="text" value="${val}" class="wa-builder-input flex-1 bg-transparent text-sm font-bold text-emerald-900 outline-none" placeholder="Deine Nachricht..." oninput="updateWaInput()">
                <button type="button" onclick="this.parentElement.remove(); updateWaInput();" class="text-emerald-300 hover:text-red-500 transition">
                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                </button>
            `;
            container.appendChild(wrapper);
            lucide.createIcons();
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Restore details state
            const openCategories = JSON.parse(localStorage.getItem('admin_open_categories') || '[]');
            document.querySelectorAll('details[data-category]').forEach(el => {
                const catId = el.getAttribute('data-category');
                if (openCategories.includes(catId)) el.open = true;

                el.addEventListener('toggle', () => {
                    const currentOpen = JSON.parse(localStorage.getItem('admin_open_categories') || '[]');
                    const newOpen = el.open
                        ? [...new Set([...currentOpen, catId])]
                        : currentOpen.filter(id => id !== catId);
                    localStorage.setItem('admin_open_categories', JSON.stringify(newOpen));
                });
            });

            // AJAX Form Submit
            const form = document.querySelector('form');
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = document.getElementById('save-btn');
                const text = document.getElementById('save-text');
                const icon = document.getElementById('save-icon');

                // Loading state
                btn.disabled = true;
                btn.classList.add('opacity-80', 'cursor-not-allowed');
                const originalText = text.innerText;
                text.innerText = 'Speichere...';

                try {
                    const formData = new FormData(form);
                    const res = await fetch(form.action, {
                        method: 'POST',
                        body: formData
                    });

                    if (res.ok) {
                        text.innerText = 'Gespeichert! ‚ú®';
                        btn.classList.replace('from-violet-600', 'from-emerald-500');
                        btn.classList.replace('to-indigo-600', 'to-emerald-600');
                        setTimeout(() => {
                            text.innerText = originalText;
                            btn.disabled = false;
                            btn.classList.remove('opacity-80', 'cursor-not-allowed');
                            btn.classList.replace('from-emerald-500', 'from-violet-600');
                            btn.classList.replace('to-emerald-600', 'to-indigo-600');
                        }, 2000);
                    } else {
                        throw new Error('Save failed');
                    }
                } catch (err) {
                    text.innerText = 'Fehler beim Speichern ‚ùå';
                    setTimeout(() => {
                        text.innerText = originalText;
                        btn.disabled = false;
                        btn.classList.remove('opacity-80', 'cursor-not-allowed');
                    }, 2000);
                }
            });

            // Stats init
            const stats = parseStats();
            if (stats.length === 0) {
                const statsList = document.getElementById('stats-list');
                if (statsList) addStatRow();
            } else stats.forEach(s => addStatRow(s));

            // WhatsApp init
            const waInput = document.getElementById('wa-hidden-input');
            if (waInput) {
                const msgs = waInput.value.split('\n').filter(x => x.trim());
                if (msgs.length === 0) {
                    if (document.getElementById('wa-list')) addWaRow();
                } else msgs.forEach(m => addWaRow(m));
            }
        });
    </script>
</body>

</html>